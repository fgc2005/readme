![MacDown logo](https://ufactory.cc/wordpress/wp-content/uploads/2015/11/logo-header.png)

# UArm2 iOS 文档介绍

## 环境
### 工具
xcode 7.3.1
### 第三方库
CocoaAsyncSocket

Masonry

## 通信协议

### 通信方式
Socket（套接字）通过UArm2的wifi模块在局域网中进行数据通信，wifi模块具有唯一的固定的ip，有两个不同的端口，分别用于数据收发跟数据流

视频流采用rtsp协议

### 通信协议格式
未加密 (是否需要加密待讨论)

发送跟响应格式一致

|  |  |  |  |
|:-------------:|:---------------:| :-------------:| :-------------:|
| 标志头 | 命令头+命令体的长度 | 命令头 | 命令体 |

#### 标志头(长度固定)
```
  char hdr_sig[4] = {0x11, 0x22, 0x33, 0x44}
```
 
  一个长度固定的长度为4的十六进制数组，数组内容确定后不能改变，用于表示这个是哪个app发送的命令。


#### 命令头+命令体的长度(长度固定)
```
uint16_t（unsigned short）
```

用2个字节的数字表示命令头+命令体的长度，因为命令头长度固定，命令体长度也可以由此计算。


#### 命令头(长度固定)
```
typedef struct
{
    unsigned short      body_length; (body长度)
    unsigned char       protocol_version; (协议版本)
    unsigned short      sequence_number;  (自增长序列)
    unsigned short      cmd_id;  (命令ID，例如 0x0116， 0x0117)
    unsigned short      flags;   (是否有回复，待定，默认为0x8000，表示需要返ack)
} cmd_header;
```

表示每条指令的公共信息，请求端跟响应端格式保持一致，用一个结构体表示，长度固定

#### 命令体(长度变化)

通过参数的形式追加	

## 通信协议(框架草稿)
### 连接
#### IP
wifi 固定为 192.168.1.1
#### PORT
socket通信端口为2001

rtsp端口为554

#### 连接流程(具体命令下面描述)

- `-`

1. Socket Client(下称Client)连接Socket Server(下称Server)端口。

1. Client发送Server设置密码命令(带密码参数)(如果已经设置可以略过)。（忽略）

1. Client发送Server打开请求命令。

1. Server返回连接成功命令，并返回相关参数(device_id, device_name, device_type, device_version，user_type等)，或者返回连接失败的提示，并指明失败原因。

#### 发送请求有响应

```
***** 设置设备信息
```

请求：

| 字段 | 类型 | 说明 | 实例 |
|:------------- |:---------------:| :-------------:|-------------:|
|deviceName[10]|uint8_t|用户名最多允许9个ASCII字符，以'\0'结尾| |

（密码, 不需要）

| 字段 | 类型 | 说明 | 实例 |
|:------------- |:---------------:| :-------------:|-------------:|
|password[6]|uint8_t|密码能且仅能6个ASCII字符，不以'\0'结尾| |
|DeviceInfoChecksum[4]|uint8_t|是用来判断主控是否新设备| |
|mctype|uint8_t|是用来判断主控是否新设备| |

返回：

| 字段 | 类型 | 说明 | 实例 |
|:------------- |:---------------:| :-------------:|:-------------:|
|status|uint8_t|是否请求成功返回标识| 0 |

```
***** 打开设备开关命令(开启后设备开始接收数据)
```

请求：

| 字段 | 类型 | 说明 | 实例 |
|:------------- |:---------------:| :-------------:|-------------:|

返回：

| 字段 | 类型 | 说明 | 实例 |
|:------------- |:---------------:| :-------------:|:-------------:|
|status|uint8_t|是否请求成功返回标识| 0 |

```
***** 关闭设备开关命令(关闭后设备停止接收数据)
```

请求：

| 字段 | 类型 | 说明 | 实例 |
|:------------- |:---------------:| :-------------:|-------------:|

返回：

| 字段 | 类型 | 说明 | 实例 |
|:------------- |:---------------:| :-------------:|:-------------:|
|status|uint8_t|是否请求成功返回标识| 0 |

```
***** 设置拍摄点（是否主控可以记录，还是app记录）
```

请求：

| 字段 | 类型 | 说明 | 实例 |
|:------------- |:---------------:| :-------------:|-------------:|
|start|Float32[]| 一个坐标用一个数组表示 | [1.1, 2.2, 3.3] |
|end|Float32[]| 一个坐标用一个数组表示 | [1.1, 2.2, 3.3] |
|mid|Float32[][]| 中间坐标用二维数组表示 | [ [1.1, 2.2, 3.3], [4.4, 5.5, 6.6] ] |

返回：

| 字段 | 类型 | 说明 | 实例 |
|:------------- |:---------------:| :-------------:|:-------------:|
|status|uint8_t|是否请求成功返回标识| 0 |

```
***** 开始预览
```

请求：

| 字段 | 类型 | 说明 | 实例 |
|:------------- |:---------------:| :-------------:|-------------:|
|mode|uint8_t|预览的三种模式，1 为延时，2 为环拍，3 为 摇臂| 1，2 或者 3 |

(如果主机中不存储拍摄点，则这里添加设置拍摄点中的参数)

返回：

| 字段 | 类型 | 说明 | 实例 |
|:------------- |:---------------:| :-------------:|:-------------:|
|status|uint8_t|是否请求成功返回标识| 0 |

```
***** 开始拍摄
```

请求：

| 字段 | 类型 | 说明 | 实例 |
|:------------- |:---------------:| :-------------:|-------------:|
| mode | uint8_t | 拍摄的三种模式，1 为延时，2 为环拍，3 为 摇臂 | 1，2 或者 3 |

(如果主机中不存储拍摄点，则这里添加设置拍摄点中的参数)

返回：

| 字段 | 类型 | 说明 | 实例 |
|:------------- |:---------------:| :-------------:|:-------------:|
|status|uint8_t|是否请求成功返回标识| 0 |

```
***** 设置回归点(设置回归点，返回回归点的功能是否需要？)
```

请求：

| 字段 | 类型 | 说明 | 实例 |
|:------------- |:---------------:| :-------------:|-------------:|
|homepoint|Float32[]| 一个坐标用一个数组表示 | [1.1, 2.2, 3.3] |

返回：

| 字段 | 类型 | 说明 | 实例 |
|:------------- |:---------------:| :-------------:|:-------------:|
|status|uint8_t|是否请求成功返回标识| 0 |

```
***** 返回回归点
```

请求：

| 字段 | 类型 | 说明 | 实例 |
|:------------- |:---------------:| :-------------:|-------------:|


返回：

| 字段 | 类型 | 说明 | 实例 |
|:------------- |:---------------:| :-------------:|:-------------:|
| status | uint8_t | 是否请求成功返回标识 | 0 |

```
***** 获取回归点
```

请求：

| 字段 | 类型 | 说明 | 实例 |
|:------------- |:---------------:| :-------------:|-------------:|


返回：

| 字段 | 类型 | 说明 | 实例 |
|:------------- |:---------------:| :-------------:|:-------------:|
| status | uint8_t | 是否请求成功返回标识 | 0 |
|homepoint|Float32[]| 一个坐标用一个数组表示 | [1.1, 2.2, 3.3] |

#### Client只请求命令(Server端无需返回响应)

```
***** move，以一定的速度移动指定参数的方向(参数待修改确定)
```

请求：

| 字段 | 类型 | 说明 | 实例 |
|:------------- |:---------------:| :-------------|-------------:|
| speed | Float32 | 速度必须大于0（是否需要速度？） |  |
| pitch | uint32_t | 负数为反方向 |  |
| yaw | uint32_t | 负数为反方向 |  |
| roll | uint32_t | 负数为反方向 |  |




#### Client只接收命令(Server端无需接收Clint端的请求)

```
***** 周期返回状态
```

返回：

| 字段 | 类型 | 说明 | 实例 |
|:------------- |:---------------:| :-------------:|:-------------:|
| status | uint8_t | 是否请求成功返回标识 | 0 |
| fwclock | int64_t | 毫秒时钟 | 1466394259405 |
| takemode | int32_t | 拍摄模式 | 1 为延时，2 为环拍，3 为 摇臂 |
| runmode | int32_t | 运行模式 | 1 为普通，2 为预览，3 为 拍摄。预览或者拍摄模式下，移动请求不起作用 |